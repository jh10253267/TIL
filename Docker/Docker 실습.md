# Docker 실습

## 개요

도커 이미지는 프로그램을 실행하는데 필요한 모든 것을 가지고 있다. 그리고 하나의 도커 이미지를 바탕으로 여러개의 인스턴스를 만들 수 있다.

도커 이미지는 설계도이고 인스턴스는 실제 프로그램이라고 볼 수 있다.

도커 파일이란 도커 이미지를 구성하기 위해 있어야할 패키지, 의존성, 소스코드 등을 하나의 파일로 기록하여 이미지화 시킬 명령 파일이다.

간단하게 스프링부트 프로젝트를 생성하고 터미널 창을 열어준다.
```
./gradlew build
```
위의 명령어를 입력하면 jar파일이 생성된다.

사실 이렇게 안해도 인텔리제이 기준으로 오른쪽 탭에 gradle build 메뉴가 있다. 이 걸 클릭해도 된다.

이렇게 하면 루트 경로에 build 디렉토리가 생긴다.

여기서 build/libs내부를 보면 우리의 프로젝트가 빌드된 것을 확인할 수 있다.

아마 `프로젝트명-0.0.1-SNAPSHOT.plain.jar`, `프로젝트명-0.0.1-SNAPSHOT.jar` 이 두가지 파일이 보일텐데 우선 배포하거나 컨테이너화 시킬 때 plain이 붙은 것을 사용하면 안된다.

여기엔 의존성을 포함하고있지 않기 때문에 실행이 안된다.

여기서 jar파일의 이름을 변경하고싶다면 build.gradle에 다음과 같이 설정한다.
```
bootJar {
    archiveFileName = "프로젝트.jar"
}
```

이렇게 하고 다시 빌드해보면 프로젝트.jar이라는 이름으로 생성되는 것을 확인할 수 있다.

여기까지 했다면 이제 도커 이미지를 만들 도커 파일을 작성하면된다.

루트 경로에 Dockefile이라는 이름으로 새로운 파일을 만들어준다.

DockerFile로 작성하면 오류가난다.
```
FROM openjdk:17
ARG JAR_FILE=build/libs/app.jar
COPY ${JAR_FILE} ./app.jar
ENV TZ=Asia/Seoul
ENTRYPOINT ["java", "-jar", "./app.jar"]
```

우선 from은 새로운 이미지를 생성할 때 기반으로 사용할 이미지를 지정한다. jdk17이 있는 컨테이너를 사용한다는 의미이다.

arg는 이미지 빌드 시점에 사용할 변수를 지정한다.
copy는 호스트에 있는 파일이나 디렉토리를 Docker이미지의 파일 시스템으로 복사하는 것이다.

예를 들어 build/libs/app.jar 라는 파일을 ./app,jar로 카피하는 것이다.

ENV는 컨테이너에서 사용할 환경 변수를 지정한다.
ENTRYPOINT는 컨테이너가 실행되었을 때 항상 실행되어야하는 커멘드를 지정하는 부분이다.

이렇게 작성하고 터미널에서 `docker build -t 도커허브아이디/이미지이름 .`를 입력한다.

이렇게하면 도커 파일이 도커 이미지로 빌드된다.

만약 만들어진 이미지를 확인하고싶다면 docker images를 입력해서 확인하면 된다.

이렇게 만들어진 이미지를 이용해 인스턴스를 만들 수 있다.

`docker run 이미지명 -p 8080:8080`
맨 마지막의 -p옵션은 컨테이너가 독립된 환경에서 작동하기 때문에 리퀘스트의 포트를 컨테이너 내부의 포트로 포워딩을 시켜준다.

이렇게 하고 컨테이너가 잘 띄워졌는지 확인하고 싶다면 다른 터미널을 열어서 docker ps 명령어로 확인할 수 있다.

이 컨테이너의 내부로 접속해볼 수도 있다.

`docker exec -it 컨터이너아이디 bash`


