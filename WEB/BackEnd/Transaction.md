# Transaction

## 개요

어렵게 말하면 트랜잭션이지만 우리가 일상 생활에서 많이 경험해본 것이다.

예를 들어 ATM에서 출금을 할 때 순서는 이렇게 된다.
1. 잔액을 조회한다.
2. 출금하려는 금액이 잔액보다 작은지 검사한다.
3. 출금하려는 금액이 잔액보다 작다면 잔액에서 출금액을 뺀 금액으로 수정한다.
4. 출금 내용을 기록한다.
5. 출금한다.

이러한 절차를 거쳐서 우리는 ATM기에서 돈을 뽑을 수 있을 것이다.

그런데 만약에 중간에서 오류가 난다면 어떻게 될까?

예를 들면 잔액에서 출금액을 뺀 금액으로 수정하고 그 정보를 기록하고 돈을 반환하는데 오류가 난다. 위의 절차들을 묶어서 하나의 출금 기능을 수행하는데 중간에 오류가 난다면 그 하위의 작업들을 수행할 수 없을 것이다.

즉, 통장에는 내가 출금을 원하는 금액만큼의 액수가 마이너스 처리가 되었다. 근데 문제가 생겨서 내가 돈을 받지 못하게 된 것이다.

이런 상황을 막기 위한 개념이 바로 Transaction이다.

우리가 사용하는 ATM기에서는 이러한 상황에서 처음부터 다시 시도해달라는 안내를 해주고 돈을 반환해준다. 

트랜잭션의 개념은 일상 생활에서도 쉽게 접할 수 있는 개념인 것이다.

## 개념

트랜잭션이란 데이터베이스 시스템에서 하나의 논리적 기능을 정상적으로 수행하기 위한 작업의 기본 단위이다.

위의 출금 작업은 하나의 논리적 기능으로 묶이고 관리되어야한다.

트랜잭션은 4가지의 특성을 가지는데 
1. 원자성(Atomicity) : 트랜잭션을 구성하는 연산 전체가 정상적으로 실행되거나 모두 취소되어야한다.

위에서 살펴본 예와 같이 우리는 일상 생활에서 ATM기를 이용하다가 처음부터 다시 시도해달라는 안내를 받아본 적이 있을 것이다. 이러한 성질이 원자성이다.

2. 일관성

트랜잭션의 작업 처리 결과가 항상 일관성이 있어야한다는 특성이다.

트랜잭션이 진행되는 동안에 데이터가 변경되더라도 업데이트된 데이터로 트랜잭션이 진행되는 것이 아니라 처음 트랜잭션이 시작될 때 참조한 데이터로 진행된다. 작업을 한 겹 감싸서 외부와 격리시키는 이미지이다.

3. 독립성
독립성은 둘 이상의 트랜잭션이 동시에 실행되고 있을 때 어느 하나의 트랜잭션이라도 다른 트랜잭션의 연산에 끼어들 수 없는 특성이다. 하나의 트랜잭션이 완료될 때까지 다른 트랜잭션이 특정 트랜잭션의 결과를 참조할 수 없다.

이 부분을 간단하게 테스트해볼 수 있는데 로컬에서 두 개의 터미널을 열어 입력했던 내용이 자동으로 커밋되거나 롤백되지 않도록 설정한다면 다른 터미널에서 확인했을 때 이전에 입력했던 내용이 다른 터미널에서 적용되지 않는 현상을 볼 수 있다.

4. 지속성
지속성은 트랜잭션이 성공적으로 완료되었을 경우 결과는 영구적으로 반영되어야한다는 특성이다.

## 상태 변화

트랜잭션의 상태는 다음과 같다.

1. 활동상태 : 트랜잭션이 실행중일 때 가지는 상태이다.
2. 부분 완료 상태 : 마지막 명령문이 실행된 후에 가지는 상태이다.
3. 완료상태 : 트랜잭션이 성공적으로 완료된 후 가지는 상태이다.
4. 실패 상태 : 정상적인 실행이 더 이상 진행될 수 없을 때 가지는 상태. 
5. 철회상태 : 트랜잭션이 취소되고 데이터베이스가 트랜잭션 시작 전 상태로 환원된 상태이다.

## 제어

트랜잭션은 Commit, rollback, checkpoint등의 명령어를 사용해서 제어할 수 있다.

commit은 트랜잭션의 결과를 데이터베이스에 영구적으로 저장하는 명령어이다.

rollback은 트랜잭션 내역을 저장 무효화시키는 명령어이다.

checkpoint는 rollback을 위한 시점을 지정하는 명령어이다.

## 사용법

서비스를 개발할 때 트랜잭션을 어떻게 사용할 수 있을지 생각해보자.

채팅방을 예로 들면 채팅방을 우선 만들어야하고 채팅방을 만든 유저를 초대해야한다. 그러나 채팅방은 만들어졌는데 유저를 초대하는 것에 실패했다고 해보자. 그럼 아무도 없는 채팅방이 만들어질 것이고 체팅을 할 수 없을 것이다.

이러한 경우에 채팅방 생성과 유저 초대를 하나의 작업으로 묶어서 모두 적용되거나 적용되지 않게 해야한다.

여러개의 데이터 베이스 요청을 하나의 작업 단위로 묶어야하기 때문에 트랜잭션은 서비스 레이어에 적용되어야한다.

스프링에서는 `@Transactional` 애노테이션을 사용하여 트랜잭션을 적용할 수 있다.

이는 클래스 단위에 적용할 수도 있고 메소드 단위에 적용할 수 있다.