# 비동기 프로그래밍

## 개요

신뢰성 있는 서비스를 위해 회원 가입 신청을 하면 검증을 위해 이메일을 보내는 경우가 많다. 여기서 회원가입 신청을 하자마자 바로 내 메일함에 검증 이메일이 도착할 필요는 없다. 조금은 지연되도 크게 상관이 없다.

이렇게 구현해야하는 것들 중에 A다음 B가 일어나야하는 요구사항들은 실제로 A 다음 최대 언제까지 B가 일어나야한다는 경우로 생각할 수 있다.

이렇게 최대 언제까지 B를 해도 큰 문제가 없는 경우에는 이벤트를 비동기로 처리하는 방식으로 구현할 수 있다.

## 비동기 구현

이벤트를 비동기로 구현할 수 있는 방법은 다양하다.
대표적으로 4가지를 예로 들 수 있다.

1. 로컬 핸들러를 비동기로 실행하기
2. 메시지 큐를 이용하기
3. 이벤트 저장소와 이벤트 포워더 사용하기
4. 이벤트 저장소와 이밴트 제공 API사용하기


### 로컬 핸들러 비동기 실행

이벤트 핸들러를 비동기로 실행하는 방법은 이벤트 핸들러를 별도 스레드로 실행하는 것이다.

스프링에선 @Async라는 애노테이션을 사용하여 비동기로 이벤트를 처리할 수 있다.

우선 @EnableAsync애노테이션을 붙여주고 비동기로 실행할 핸들러에 @Async 애노테이션을 붙여주면 된다.

그러면 스프링은 이벤트가 발생하면 해당 메소드를 별도 스레드를 이용해서 비동기로 실행한다.

여기서 중요한 개념들은 다음과 같다.

1. CorePoolSize : 스레드 풀에서 최소한의 스레드를 몇 개를 가지고 있을 것인가
2. MaxPoolSize : 최대 몇 개까지의 스레드를 할당할 것인지
3. KeepAliveTime : 최소 스레드 이상의 스레드가 할당되었을 때 지정한 시간만큼 스레드들이 일을 하지 않으면 자원을 반납하게 하는 옵션
4. 유닛 : Long타입 워크 큐에 담아놨다가 현재 작업이 완료되면 다음 작업을 가져온다.

### 메시징 시스템을 이용한 비동기 구현

다른 방법으로는 카프카나 레빗MQ와 같은 메시징 시스템을 사용하는 것이다. 이벤트가 발생하면 이벤트 디스패쳐는 이벤트를 메시지 큐에 보낸다. 메시지 큐는 이벤트를 메시지 리스너에 전달하고 메시지 리스너는 알맞은 이벤트 핸들러를 이용해서 이벤트를 처리한다.

이 때 이벤트를 메시지 큐에 저장하는 과정과 메시지 큐에서 이벤트를 읽어와 처리하는 과정은 별도 스레드나 프로세스로 처리된다.