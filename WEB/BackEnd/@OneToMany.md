# @OneToMany

## 개요

JPA의 등장 배경에 대해 정리한 적이 있다. OneToMany도 JPA의 연관관계중 하나로 DB에서 PK를 가진 쪽에서 바라보는 관계이다.

즉, 하나의 게시글에는 여러개의 댓글이 달릴 수 있다. 이 때 게시글이 댓글을 소유하는 구조이다.

@OneToMany는 상위 엔티티에서 하위 엔티티를 관리하는 방식이고 상위 엔티티의 상태가 변경되면 하위 엔티티의 상태들도 같이 처리해야한다.

이 때 N+1 문제가 발생할 수 있기 때문에 조심해서 사용해야한다.

OneToMany는 기본적으로 각 엔티티에 해당하는 테이블을 독립적으로 생성하고 중간에 이 둘을 연결해주는 테이블이 생성된다.

이를 매핑 테이블이라고 하는데 매핑 테이블을 생성하지 않는 방법은 단방향으로 OneToMany를 적용하는 방법이 있고 @JoinColumn을 이용하거나 MappedBy 속성을 이용하는 방법이 있다. 이는 흔히 연관관계의 주인이라고 해석하곤 하는데 예를 들어 게시글의 관점에서 보면 각각의 댓글들은 모두 별개의 존재로 하나의 댓글이 여러 게시물에서 사용될 수 있는 구조를 가정하고 생성되게 된다. 반대로 댓글의 관점에서 보면 하나의 게시글을 참조하는 구조가 필요하기 때문에 mappedBy를 사용해서 첨부파일쪽의 해석을 적용할 것을 명시한다.

양방향 관계에서 중요한 것은 상위 엔티티와 하위 엔티티의 연관관계를 신경써야한다는 것이다. 계속 예를들 관계의 경우 게시글의 상태가 변경되었을 때 하위 객체들도 같이 처리가 되어야한다.(DB의 참조 무결성 개념)

이를 영속성의 전이라고 하는데 이와 같은 설정을 cascade라는 속성을 이용한다.

* PERSIST 
* REMOVE 상위 엔티티가 영속 처리될 때 하위 엔티티도 같이 처리
* MERGE
* REFRESH
* DETACH 상위 엔티티의 상태가 변경될 때 하위 엔티티들도 같이 변경
* ALL 상위 엔티티의 모든 상태 변경이 하위 엔티티에 적용

Lazy로딩

상위 엔티티를 먼저 로딩하고 필요한 경우 하위 엔티티를 로딩하는 방식.

@EntityGraph 한번에 조인처리를 하여 select가 이루어지도록 하는 방식.

attributePaths 라는 속성을 이용해서 같이 로딩해야하는 속성을 명시할 수 있다.