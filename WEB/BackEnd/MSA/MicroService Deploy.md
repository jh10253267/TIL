# MicroService Deploy

## 개요

애플리케이션 개발 과정을 생각해보면 개발자들은 작성한 소스코드를 형상 관리 시스템에 올리게 된다. 그 후 변경사항들은 빌드, 테스트를 거쳐서 배포되게 된다.

이러한 일련의 작업들을 자동화한 것이 CI/CD이고 이를 시각화한 것이 파이프라인이다.

## 컨테이너 배포

만약 컨테이너 환경이 아니라면 빌드 결과로 생성된 .jar, .war을 그대로 배포하고 배포환경에서 실행시키면 된다.

만약 컨테이너 기술을 적용한다면 도커 이미지를 생성하고 이를 관리하기 위해 컨테이너 레지스트리에 등록한다. 그리고 컨테이너 레지스트리에 등록한 도커 이미지를 사용하여 쿠버네티스 환경에 애플리케이션을 배포한다.

도커를 사용한다면 도커 파일로 한 번만 정의해두면 이 파일을 이용해서 애플리케이션을 빌드하고 컨테이너 이미지를 생성할 수 있다.

이렇게 빌드 과정을 자동화할 수 있다.

그 다음으론 배포 설정 자동화이다.. 클라우드 환경에서 애플리케이션을 배포할 때는 레플리카 수, 컨테이너 이미지와 같은 여러 설정값이 필요하다 이를 별도의 구성 파일에 명시하고 이를 사용해 배포를 자동화한다.

그리고 이 과정들을 하나의 프로세스로 동작하게 묶는다.

즉, 코드 저장소에 소스코드가 커밋되면 이를 인지하고 소스코드를 가져와서 빌드한다. 빌드가 끝나면 생성된 애플리케이션 컨테이너 이미지를 컨테이너 레지스트리에 저장한다. 여기까지가 빌드 과정이고 레지스트리에 저장된 애플리케이션 컨테이너의 이미지를 가져와서 자동으로 배포까지 완료한다.

구글에서 jib라는 오픈소스 라이브러리를 출시했다. 이는 자바 애플리케이션을 컨테이너화하는 툴로 이 것을 사용하면 명령어 한 줄로 도커 데몬이 없어도 도커 파일이 없어도 도커 이미지를 생성할 수 있다.

JHipster를 이용해서 마이크로 서비스 아키텍처를 구축했다면 이 플러그인이 자동으로 적용되어있다.

```kotlin
id "com.google.cloud.tools.jib"
```

이를 사용해서 컨테이너 이미지를 만들 수 있다. 소스코드를 깃과 같은 시스템을 이용하듯이 컨테이너 이미지도 컨테이너 레지스트리를 통해 관리할 수 있다.

대표적으로 도커 허브가 있다.

## 쿠버네티스

쿠버네티스는 컨테이너 오케스트레이션 시스템으로 구성요소에는 오브젝트와 컨트롤러가 있다.

파드는 배포 가능한 가장 작은 단위로 1개 이상의 컨테이너를 올릴 수 있다.

서비스는 파드에서 실행중인 애플리케이션을 네트워크 서비스로 노출할 필요가 있을 때 사용하는 오브젝트다.

서비스는 파드에 외부 요청을 전달하고 디플로이먼트는 파드를 관리한다.

디플로이먼트는 파드를 직접 관리하는 것이 아니라 레플리카셋을 통해 관리하는데 지정된 파드 갯수에 대한 가용성을 보장한다.

쿠버네티스에 애플리케이션을 배포하려면 이러한 오브젝트들을 생성해야한다.

여기에는 3가지 방법이 있다.

1. 명령어
2. 명령형 오브젝트
3. 선언형 오브젝트

2번과 3번 방법은 yaml 형식으로 작성된 설정 파일을 이용하여 오브젝트를 생성하는 방법이다.

### 주요 항목

* kind
* metadata.name
* spec.replicas
* sepc.selector
* template

먼저 컨테이너 이미지가 필요하다. 

```
kubectl create deployment my-nginx --image nginx
kubectl expose deployment/my-nginx --type=LoadBalancer --port=80
kubectl get all
```

이렇게 하면 디플로이먼트와 서비스까지 생성이 완료된다.

### GCP

Google Cloud Platform은 구글에서 제공하는 클라우드 컴퓨팅 서비스로 신규 가입시 무료 크레딧이 제공된다.


