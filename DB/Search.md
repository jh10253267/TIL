# 검색

## 개요

포털사이트에서 검색을 하면 그 검색어랑 완전히 일치하는 글만 나오는 것이 아니라 포함되어있는 글들도 나온다.

이는 MySQL의 like 문법을 사용해 구현할 수 있다.

그러나 한 가지 한계점이 있는데 SELECT 문법의 WHERE 절의 조건으로 사용되는 속성에 인덱스를 걸어 사용하는 경우가 일반적인데 이렇게 일치하는 결과만 뽑는 것이 아니라 포함하고 있는 결과도 뽑으려면 와일드 카드를 이용해야한다.

예를 들면 이렇다.
```sql
SELECT * FROM post WHERE title LIKE '%test%'
```

이렇게 하면 testPost, Potestst... 등등 제목에 test를 포함하고 있는 결과들이 출력된다.

쿼리가 실행될 때 DB의 쿼리 옵티마이저가 판단해서 인덱스를 사용하는 것이 빠른 경우, 인덱스를 사용할 수 있는 경우 등등을 파악해서 쿼리를 실행시킨다.
인덱스 테이블은 원래 값의 첫 글자부터 시작해서 정렬된다. 그러나 첫 글자가 무엇인지 알 수 없다면 인덱스를 사용할 수 없다.

따라서 와일드 카드가 앞뒤로 붙은 경우 인덱스를 타지 않고 테이블을 풀 스캔한다.

```sql
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | club  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 9718 |    11.11 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
```
인덱스가 존재함에도 possible_keys가 null인 걸 볼 수 있다.

## Full Text Search

그럼 이러한 부분 검색에 인덱스를 사용하여 검색 성능을 높이듯이 성능을 개선할 수 있는 방법이 뭐가있을까?

Mysql에서는 문자열 검색을 위해 Full Text Search를 지원한다.

이는 단어나 구문을 잘게 쪼개어 인덱스를 생성하는 방법이다.

검색 키워드와 관련이 있는 데이터들도 뽑아낼 수 있다.

Full Text Search에는 세 가지 유형이 있다.

첫 번째론 자연어 검색이다.

자연어 검색이란 검색 문자열을 자연어 구문으로 핵성하여 인덱스를 생성한다.

두 번째론 불리언 검색이다.

이는 규칙을 사용하여 검색 문자열을 핵석하는 방식이다. 

잘게 쪼개는 방식에도 여러가지가 있는데 built-in parser를 이용하는 방법과 N-gram parser를 이용하는 방법이 있다.

built-in parser는 중지단어를 기준으로 키워드를 추출하는 방식이다.

예를 들어 스페이스바가 중지단어라면 다음과 같이 쪼개진다.
```
안녕하세요 가입인사드립니다
-> 안녕하세요/가입인사드립니다
```


* 중지단어란 큰 의미가 없는 단어들을 말한다. 예를 들어 그러나, 그리고, 따라서와 같이 검색에 있어서 식별 단어로는 큰 의미가 없는 단어들이다.

N-gram parser는 지정된 토큰 사이즈를 이용하여 키워드를 추출하는 방식이다.

게시글 제목을 검색하는 경우 토큰 사이즈(조각의 단위)가 3이라면 다음과 같이 쪼개어 인덱스를 생성한다.

```
안녕하세요 가입인사드립니다
-> 안녕하/하세요/요가입/입인사/사드립/립니다
```
이제 생성해보자
```sql
ALTER TABLE 테이블명 ADD FULLTEXT 인덱스이름 (필드명) WITH PARSER ngram;
```

create문으로도 생성이 가능하다.
```sql
CREATE FULLTEXT INDEX 인덱스명 on 테이블명(필드명) WITH PARSER ngram;
```

### 생성된 인덱스 확인

생성된 인덱스를 확인하려면 다음 명령어를 입력하면 된다.

```sql
SET GLOBAL innodb_ft_aux_table = 'DB명/테이블명';

SELECT * FROM information_schema.innodb_ft_index_table;
```

### 문법

Full Text Search의 문법은 `MATCH..AGAINST`이다.

일반적인 select where 절에서 다음과 같이 작성해주면 된다.
```sql
SELECT...FROM...
WHERE MATCH(칼럼) AGAINST('keyword' NATURAL LANGUAGE MODE);
```
```sql
SELECT...FROM...
WHERE MATCH(칼럼) AGAINST('keyword' BOOLEAN MODE);
```
BOOLEAN MODE는 검색 조건을 지정할 수 있다.

예를 들어 +기호를 키워드의 앞에 붙이면 키워드를 반드시 포함하는 결과를 리턴하고 -기호를 붙이면 반드시 제외하는 단어를 리턴한다.

이 외에도 여러가지 기호가 있는데 이들은 가중치를 설정해존다.

예를 들어 >기호를 사용하면    ㅠㅠㅠㅠㅠㅠㅠㅠㅠㅠㅠ

### 테스트

데이터는 총 10001건

1부터 순차적으로 증가하는 10000개의 타이틀 데이터와 full text index를 확인하기 위해 문자열로 구성된 자료 1건 사용

ngram parser를 이용했으며 token_size는 2로 설정함.

쿼리 성능은 EXPLAIN ANALYZE 키워드를 사용함.

10번씩의 쿼리를 날려 측정함.

Full Text Search를 적용하지 않았을 때
```sql
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.443..7.55 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0536..5.8 rows=10001 loops=1)
——
> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.517..7.81 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0726..5.97 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.482..7.91 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0716..6.04 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.533..7.71 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0705..5.93 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.424..7.06 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0554..5.44 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.429..7.44 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0534..5.73 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.445..7.63 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0775..5.9 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.555..7.68 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0681..5.9 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.438..7.89 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0531..5.99 rows=10001 loops=1)
——
-> Filter: (club.title like '%500%')  (cost=1029 rows=1116) (actual time=0.528..7.78 rows=20 loops=1)
    -> Table scan on club  (cost=1029 rows=10043) (actual time=0.0743..5.98 rows=10001 loops=1)
```
10번의 쿼리를 날린 결과
Filter 평균 소요 시간 7.3466ms
Table Scan on club 평균 소요시간:
5.98165ms


```sql
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0192..0.0517 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0181..0.0482 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                             |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0594..0.183 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0575..0.176 rows=20 loops=1)
 |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                             |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.036..0.0817 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.035..0.0777 rows=20 loops=1)
 |
+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.01 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0207..0.0634 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0195..0.0593 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0202..0.0672 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0192..0.0586 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                            |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.021..0.0636 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.02..0.0595 rows=20 loops=1)
 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0216..0.0639 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0202..0.0595 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0208..0.0634 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0196..0.0592 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0212..0.0633 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0198..0.0589 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0376..0.0855 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0364..0.0812 rows=20 loops=1)
 |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.041..0.164 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.039..0.156 rows=20 loops=1)
 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> explain analyze select * from club where match(title) against ('+500' in boolean mode );
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                                                                                                                                                                                               |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Filter: (match club.title against ('+500' in boolean mode))  (cost=0.35 rows=1) (actual time=0.0205..0.0629 rows=20 loops=1)
    -> Full-text index search on club using ft_index (title='+500')  (cost=0.35 rows=1) (actual time=0.0193..0.0587 rows=20 loops=1)
 |
+-------------------------------------------------------------
```
Filter 평균 소요 시간 : 0.08849ms
Full-text index search 평균 소요 시간 0.3593ms

Filter 평균 소요 시간 약 98.79% 단축.
검색 평균 소요시간 약 94.01% 단축

쿼리가 입력되고 결과를 출력할 때까지 소요시간 약 96.643% 단축